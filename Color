--1. This query shows the artist name with their albums and the tracklist per album

SELECT
    at.Name AS artist,
    a.Title AS album,
    t.Name AS track_name
FROM tracks t
JOIN albums a
ON a.AlbumId = t.AlbumId
JOIN artists at
ON at.ArtistId = a.ArtistId;

--2. List of employees and their immediate supervisors

SELECT 
    e.FirstName AS employee_first_name,
    e.LastName AS employee_last_name,
    s.FirstName AS supervisor_first_name,
    s.LastName AS supervisor_last_name
FROM employees e
LEFT JOIN employees s
ON e.ReportsTo = s.EmployeeId;

--3. Total list of sales made by each agent

SELECT
    e.FirstName,
    e.LastName,
    ROUND(SUM(i.Total), 2) AS sales
FROM employees e
JOIN customers c
ON c.SupportRepId = e.EmployeeId
JOIN invoices i
ON i.CustomerId = c.CustomerID
WHERE e.title = 'Sales Support Agent'
GROUP BY e.FirstName, e.LastName;

--4. List of Customer IDs and full names of top fans of each artist based on track purchases

WITH ranking AS (
    SELECT
        c.CustomerId AS cust_id,
        c.FirstName AS first_name,
        c.LastName AS last_name,
        at.Name AS artist,
        COUNT(it.TrackId) AS TrackPurchases,
        DENSE_RANK() OVER(PARTITION BY at.Name ORDER BY COUNT(it.TrackId) DESC) AS Rank
    FROM customers c
    JOIN invoices inv ON inv.CustomerId = c.CustomerId
    JOIN invoice_items it ON it.InvoiceId = inv.InvoiceId
    JOIN tracks t ON t.TrackId = it.TrackId
    JOIN albums al ON al.AlbumId = t.AlbumId
    JOIN artists at ON at.ArtistId = al.ArtistId
    GROUP BY c.CustomerID, c.FirstName, c.LastName, at.Name
    ORDER BY Rank
        )

SELECT
    cust_id,
    first_name,
    last_name,
    artist,
    TrackPurchases,
    'Top Fan' AS Label
FROM ranking
WHERE Rank = 1
ORDER BY cust_id;

--5. Completionist - Show the id and names of customers that purchased an entire album

WITH tracks_per_order AS (
    SELECT 
        c.CustomerId,
        c.FirstName,
        c.LastName,        
        ab.Title AS album_title,
        COUNT(it.TrackId) AS track_count_it
    FROM customers c
    JOIN invoices inv ON inv.CustomerId = c.CustomerId
    JOIN invoice_items it ON it.InvoiceId = inv.InvoiceId
    JOIN tracks t ON t.TrackId = it.TrackId
    JOIN albums ab ON ab.AlbumId = t.AlbumId
    GROUP BY ab.Title
    )

SELECT *
  FROM trackCount
 WHERE track_count_it = (
                            SELECT COUNT(t.TrackId) 
                              FROM albums ab
                                   JOIN
                                   tracks t ON ab.AlbumId = t.AlbumId
                             WHERE trackCount.album_title = ab.title
                             GROUP BY ab.title
                        );
                        
--
WITH tracks_per_order AS (
        SELECT 
            c.CustomerId AS customer_id,
            c.FirstName AS first_name,
            c.LastName AS last_name,        
            ab.Title AS album_title,
            COUNT(it.TrackId) AS track_count_per_order
        FROM customers c
        JOIN invoices inv ON inv.CustomerId = c.CustomerId
        JOIN invoice_items it ON it.InvoiceId = inv.InvoiceId
        JOIN tracks t ON t.TrackId = it.TrackId
        JOIN albums ab ON ab.AlbumId = t.AlbumId
        GROUP BY ab.Title
        ),
    tracks_per_album AS (
        SELECT 
            COUNT(t.TrackId) AS track_count_per_album,
            ab.title AS album_title
        FROM albums ab
        JOIN tracks t ON ab.AlbumId = t.AlbumId
        GROUP BY ab.title
        )

SELECT
    customer_id,
    first_name,
    last_name,
    t1.album_title,
    track_count_per_order
FROM tracks_per_order t1
JOIN tracks_per_album t2
ON t1.track_count_per_order = t2.track_count_per_album
AND t1.album_title = t2.album_title;    

--6. Provide a query that shows the invoices associated with each sales agent. The resulting table should include the Sales Agent's full name

SELECT
    e.FirstName,
    e.LastName,
    i.InvoiceId
FROM employees e
JOIN customers c
ON c.SupportRepId = e.EmployeeId
JOIN invoices i
ON i.CustomerId = c.CustomerID
WHERE e.title = 'Sales Support Agent';

--7. Show the Invoice Total, Customer name, Country, and Sales Agent name for all invoices and customers.

SELECT
    c.FirstName,
    c.LastName,
    i.BillingCountry,
    i.Total,
    e.FirstName,
    e.LastName
FROM employees e
JOIN customers c
ON c.SupportRepId = e.EmployeeId
JOIN invoices i
ON i.CustomerId = c.CustomerID
WHERE e.title = 'Sales Support Agent';

--8. Write a query that includes the purchased track name AND artist name with each invoice line ID

SELECT
    t.Name,
    at.Name,
    it.InvoiceLineId
FROM customers c
JOIN invoices i ON i.CustomerId = c.CustomerId
JOIN invoice_items it ON it.InvoiceId = i.InvoiceId
JOIN tracks t ON t.TrackId = it.TrackId
JOIN albums ab ON ab.AlbumId = t.AlbumId
JOIN artists at ON at.ArtistId = ab.AlbumId;







